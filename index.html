<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  body {
  background: url("https://i.postimg.cc/gktF3bZr/Copilot-20250930-144314.png") no-repeat center center fixed;
  background-size: cover;
}

    h1,h2 { text-align:center; text-shadow:0 0 8px #0f0; }
    input,textarea,button,select {
      margin:6px; padding:10px; background:#001100; color:#0f0;
      border:1px solid #0f0; border-radius:6px;
    }
    button.spyBtn {
      display:inline-block; min-width:160px; padding:12px 20px; font-size:1em;
      background:#001100; color:#0f0; border:2px solid #0f0; border-radius:8px;
      box-shadow:0 0 10px rgba(0,255,0,.25); cursor:pointer; transition:.2s;
    }
    button.spyBtn:hover { background:#0f0; color:#000; }
    .row { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    .hidden { display:none; }
    .message { border-bottom:1px dashed #0f0; padding:8px; }
    img { max-width:100%; margin-top:6px; border:1px solid #0f0; }
    #messagesPanel { max-height:65vh; overflow-y:auto; padding:10px; border:1px solid #0f0; border-radius:6px; }
    #accountList { min-width:300px; }
    small.muted { color:#8f8; }
  </style>
</head>
<body>
  <h1>ğŸ•µï¸ Espion Firebase</h1>

  <!-- Choix rÃ´le -->
  <div id="choicePanel" class="row">
    <button class="spyBtn" id="btnChooseAdmin">ğŸ” Admin</button>
    <button class="spyBtn" id="btnChooseUser">ğŸ‘¤ Utilisateur</button>
  </div>

  <!-- Connexion avec CAPTCHA -->
  <div id="loginPanel" class="hidden">
    <h2 id="loginTitle">Connexion</h2>
    <div class="row">
      <input type="text" id="loginId" placeholder="Identifiant" />
      <input type="password" id="loginPwd" placeholder="Mot de passe" />
    </div>

    <!-- CAPTCHA maison -->
    <p id="captchaQuestion"></p>
    <input type="text" id="captchaAnswer" placeholder="RÃ©ponse au CAPTCHA" />

    <button class="spyBtn" id="btnLogin">Se connecter</button>
    <p id="loginError"></p>
    <div class="row"><button class="spyBtn" id="btnBackLogin">â¬… Retour</button></div>
  </div>

  <!-- Portail -->
  <div id="portalPanel" class="hidden">
    <h2>Centre de contrÃ´le</h2>
    <p style="text-align:center;">Bienvenue, <span id="userName"></span> <small id="userRole" class="muted">(rÃ´le)</small></p>
    <div class="row">
      <button class="spyBtn" id="btnMessages">ğŸ“¥ Messages globaux</button>
      <button class="spyBtn" id="btnGestion">ğŸ” GÃ©rer les comptes</button>
      <button class="spyBtn" id="btnEnvoi">ğŸ“¤ Envoyer un message</button>
      <button class="spyBtn" id="btnLogout">ğŸšª DÃ©connexion</button>
    </div>
  </div>

  <!-- Messages -->
  <div id="messagesPanel" class="hidden">
    <h2>ğŸ“¥ Messages globaux</h2>
    <div id="messages"></div>
    <div class="row"><button class="spyBtn btnBack">â¬… Retour</button></div>
  </div>

  <!-- Gestion comptes -->
  <div id="gestionPanel" class="hidden">
    <h2>ğŸ” Gestion des comptes</h2>
    <div class="row">
      <input type="text" id="newId" placeholder="Identifiant" />
      <input type="password" id="newPwd" placeholder="Mot de passe" />
      <select id="newRole">
        <option value="user">Utilisateur</option>
        <option value="admin">Admin</option>
      </select>
      <button class="spyBtn" id="btnCreate">CrÃ©er</button>
    </div>
    <p id="createMsg"></p>
    <div class="row">
      <select id="accountList"></select>
      <button class="spyBtn" id="btnDeleteAccount">Supprimer</button>
      <button class="spyBtn" id="btnToggleBlock">Bloquer/DÃ©bloquer</button>
    </div>
    <p id="actionMsg"></p>
    <div class="row"><button class="spyBtn btnBack">â¬… Retour</button></div>
  </div>

  <!-- Envoi -->
  <div id="envoiPanel" class="hidden">
    <h2>ğŸ“¤ Envoyer un message</h2>
    <div class="row">
      <textarea id="msgText" placeholder="Message..." rows="4" style="min-width:300px;"></textarea>
      <div>
        <input type="file" id="imageInput" accept="image/*" />
        <img id="preview" style="display:none;" />
      </div>
    </div>
    <div class="row">
      <button class="spyBtn" id="btnSend">Envoyer</button>
    </div>
    <p id="sendStatus"></p>
    <div class="row"><button class="spyBtn btnBack">â¬… Retour</button></div>
  </div>

  <!-- Firebase + logique -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, push, get, child, onChildAdded, remove, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYg_ZFP7TNsSyxAUkpXsTZIUoDl3FGRIw",
      authDomain: "chat-2013.firebaseapp.com",
      databaseURL: "https://chat-2013-default-rtdb.firebaseio.com",
      projectId: "chat-2013",
      storageBucket: "chat-2013.firebasestorage.app",
      messagingSenderId: "164773159255",
      appId: "1:164773159255:web:2a273018f619687d88de12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const comptesRef = ref(db, "comptes");
    const messagesRef = ref(db, "messages");

    const el = id => document.getElementById(id);
    const showOnly = id => {
      ["choicePanel","loginPanel","portalPanel","messagesPanel","gestionPanel","envoiPanel"]
        .forEach(p => el(p).classList.add("hidden"));
      el(id).classList.remove("hidden");
    };

    let selectedRole = null;
    let currentUser = null;
    let currentUserRole = null;
    let a, b; // pour le captcha

    // GÃ©nÃ¨re une question CAPTCHA
    function newCaptcha() {
      a = Math.floor(Math.random()*10)+1;
      b = Math.floor(Math.random()*10)+1;
      el("captchaQuestion").textContent = `Combien font ${a} + ${b} ?`;
      el("captchaAnswer").value = "";
    }

    // Choix rÃ´le
    el("btnChooseAdmin").onclick = () => { selectedRole="admin"; el("loginTitle").textContent="Connexion Admin"; newCaptcha(); showOnly("loginPanel"); };
    el("btnChooseUser").onclick = () => { selectedRole="user"; el("loginTitle").textContent="Connexion Utilisateur"; newCaptcha(); showOnly("loginPanel"); };
    el("btnBackLogin").onclick = () => { showOnly("choicePanel"); };

    // Connexion avec CAPTCHA
    el("btnLogin").onclick = async () => {
      const id = el("loginId").value.trim();
      const pwd = el("loginPwd").value.trim();
      el("loginError").textContent = "";

      // VÃ©rifie le CAPTCHA
      const answer = parseInt(el("captchaAnswer").value, 10);
      if (answer !== a+b) {
        el("loginError").textContent = "âŒ Mauvaise rÃ©ponse au CAPTCHA.";
        newCaptcha();
        return;
      }

      const snap = await get(comptesRef);
      let match = null;
      snap.forEach(cs => {
        const v = cs.val();
        if (v && v.identifiant===id && v.motdepasse===pwd && !v.bloque) match = v;
      });
        if (!match) {
        el("loginError").textContent = "âŒ Identifiants incorrects ou compte bloquÃ©.";
        newCaptcha();
        return;
      }
      if (selectedRole === "admin" && match.role !== "admin") {
        el("loginError").textContent = "âŒ AccÃ¨s rÃ©servÃ© aux admins.";
        newCaptcha();
        return;
      }

      currentUser = id;
      currentUserRole = match.role || "user";
      el("userName").textContent = currentUser;
      el("userRole").textContent = "(" + currentUserRole + ")";
      showOnly("portalPanel");
    };

    // DÃ©connexion
    el("btnLogout").onclick = () => {
      currentUser = null;
      currentUserRole = null;
      el("messages").innerHTML = "";
      showOnly("choicePanel");
    };

    // Messages temps rÃ©el
    function attachMessagesListener() {
      el("messages").innerHTML = "";
      onChildAdded(messagesRef, snap => {
        const msg = snap.val();
        if (!msg) return;
        const div = document.createElement("div");
        div.className = "message";
        div.innerHTML = `<b>${msg.auteur}</b>: ${msg.texte}`;
        if (msg.image) {
          const img = document.createElement("img");
          img.src = msg.image;
          div.appendChild(img);
        }
        el("messages").prepend(div);
      });
    }

    el("btnMessages").onclick = () => {
      showOnly("messagesPanel");
      attachMessagesListener();
    };

    // Gestion des comptes
    async function refreshAccounts() {
      el("accountList").innerHTML = "";
      const snap = await get(comptesRef);
      snap.forEach(cs => {
        const v = cs.val();
        if (v) {
          const opt = document.createElement("option");
          opt.value = cs.key;
          opt.textContent = `${v.identifiant} [${v.role}]` + (v.bloque ? " (bloquÃ©)" : "");
          el("accountList").appendChild(opt);
        }
      });
    }

    el("btnGestion").onclick = () => {
      if (currentUserRole !== "admin") {
        alert("AccÃ¨s rÃ©servÃ© aux admins.");
        return;
      }
      refreshAccounts();
      showOnly("gestionPanel");
    };

    el("btnCreate").onclick = async () => {
      const id = el("newId").value.trim();
      const pwd = el("newPwd").value.trim();
      const role = el("newRole").value;
      if (!id || !pwd) { el("createMsg").textContent = "âŒ Remplis les champs."; return; }
      await push(comptesRef, { identifiant:id, motdepasse:pwd, role, bloque:false });
      el("createMsg").textContent = "âœ… Compte crÃ©Ã©.";
      refreshAccounts();
    };

    el("btnDeleteAccount").onclick = async () => {
      const key = el("accountList").value;
      if (!key) return;
      await remove(child(comptesRef, key));
      el("actionMsg").textContent = "âœ… Compte supprimÃ©.";
      refreshAccounts();
    };

    el("btnToggleBlock").onclick = async () => {
      const key = el("accountList").value;
      if (!key) return;
      const snap = await get(child(comptesRef, key));
      const v = snap.val();
      await update(child(comptesRef, key), { bloque: !v.bloque });
      el("actionMsg").textContent = v.bloque ? "âœ… Compte dÃ©bloquÃ©." : "âœ… Compte bloquÃ©.";
      refreshAccounts();
    };

    // Envoi de message
    el("btnEnvoi").onclick = () => { showOnly("envoiPanel"); };
    el("imageInput").onchange = () => {
      const file = el("imageInput").files[0];
      if (!file) { el("preview").style.display="none"; return; }
      const reader = new FileReader();
      reader.onload = () => { el("preview").src = reader.result; el("preview").style.display="block"; };
      reader.readAsDataURL(file);
    };
    el("btnSend").onclick = async () => {
      const texte = el("msgText").value.trim();
      const img = (el("preview").style.display!=="none") ? el("preview").src : "";
      if (!texte) { el("sendStatus").textContent = "âŒ Message vide."; return; }
      await push(messagesRef, { auteur:currentUser, texte, image:img, ts:Date.now() });
      el("sendStatus").textContent = "âœ… Message envoyÃ©.";
      el("msgText").value = ""; el("preview").style.display="none";
    };

    // Boutons retour
    document.querySelectorAll(".btnBack").forEach(b => b.onclick = () => showOnly("portalPanel"));
  </script>
</body>
</html>

